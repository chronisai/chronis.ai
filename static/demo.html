<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chronis — Live Demo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&family=Geist+Mono:wght@300;400&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    :root{
      --black:#080808;--surface:rgba(255,255,255,0.03);--surface2:rgba(255,255,255,0.055);
      --border:rgba(255,255,255,0.08);--border2:rgba(255,255,255,0.14);
      --text:#f0ede8;--muted:rgba(240,237,232,0.42);--faint:rgba(240,237,232,0.13);
      --accent:#f0ede8;
    }
    html,body{height:100%}
    body{
      font-family:'Geist Mono',monospace;background:var(--black);
      color:var(--text);-webkit-font-smoothing:antialiased;overflow:hidden;
    }
    body::before{
      content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:.3;
      background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.05'/%3E%3C/svg%3E");
    }

    /* ── Layout ── */
    .app{display:flex;flex-direction:column;height:100vh}

    /* Top bar */
    .topbar{
      flex-shrink:0;display:flex;align-items:center;justify-content:space-between;
      padding:0 24px;height:56px;border-bottom:1px solid var(--border);
      background:rgba(8,8,8,.9);backdrop-filter:blur(20px);
    }
    .topbar-left{display:flex;align-items:center;gap:16px}
    .logo{font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:300;letter-spacing:.15em}
    .demo-tag{font-size:9px;letter-spacing:.2em;color:var(--faint);text-transform:uppercase;padding:3px 8px;border:1px solid var(--border);border-radius:100px}
    .back-link{font-size:10px;letter-spacing:.1em;color:var(--muted);text-decoration:none;text-transform:uppercase;transition:color .3s}
    .back-link:hover{color:var(--text)}

    /* Person tag in topbar (shown after analysis) */
    .person-tag{
      display:none;align-items:center;gap:8px;
      padding:5px 12px;border:1px solid var(--border2);border-radius:100px;
      font-size:11px;color:var(--muted);
    }
    .person-tag.show{display:flex}
    .person-tag strong{color:var(--text);font-weight:400}
    .pulse{width:6px;height:6px;background:rgba(240,237,232,.6);border-radius:50%;animation:blink 2s ease-in-out infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

    /* ── Main content area ── */
    .main{flex:1;display:flex;overflow:hidden}

    /* ── Upload Panel ── */
    #uploadPanel{
      flex-shrink:0;width:360px;border-right:1px solid var(--border);
      display:flex;flex-direction:column;padding:32px 28px;gap:24px;
      overflow-y:auto;transition:width .4s ease,opacity .4s ease;
    }
    #uploadPanel.collapsed{width:0;padding:0;opacity:0;overflow:hidden}

    .panel-label{font-size:9px;letter-spacing:.25em;color:var(--faint);text-transform:uppercase;margin-bottom:4px}
    .panel-title{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:300;line-height:1.2;margin-bottom:6px}
    .panel-sub{font-size:11px;color:var(--muted);line-height:1.8;letter-spacing:.02em}

    /* Name input */
    .input-group{display:flex;flex-direction:column;gap:6px}
    .input-label{font-size:10px;letter-spacing:.15em;color:var(--faint);text-transform:uppercase}
    input[type=text]{
      width:100%;padding:13px 16px;background:var(--surface);
      border:1px solid var(--border);border-radius:8px;
      color:var(--text);font-family:'Geist Mono',monospace;font-size:13px;
      outline:none;transition:border-color .3s;
    }
    input[type=text]:focus{border-color:var(--border2)}
    input[type=text]::placeholder{color:var(--faint)}

    /* Drop zone */
    .dropzone{
      border:1px dashed var(--border2);border-radius:12px;
      padding:32px 20px;text-align:center;cursor:pointer;
      transition:border-color .3s,background .3s;position:relative;
    }
    .dropzone:hover,.dropzone.drag-over{border-color:rgba(240,237,232,.35);background:rgba(255,255,255,.03)}
    .dropzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
    .dz-icon{font-size:28px;margin-bottom:12px;opacity:.4}
    .dz-text{font-size:12px;color:var(--muted);line-height:1.7;letter-spacing:.02em}
    .dz-sub{font-size:10px;color:var(--faint);margin-top:6px;letter-spacing:.05em}
    .file-selected{
      display:none;align-items:center;gap:10px;
      padding:12px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;
    }
    .file-selected.show{display:flex}
    .file-icon{font-size:18px;opacity:.6}
    .file-name{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .file-remove{background:none;border:none;color:var(--faint);cursor:pointer;font-size:16px;padding:0 4px;transition:color .2s}
    .file-remove:hover{color:var(--text)}

    /* Analyze button */
    .analyze-btn{
      width:100%;padding:14px;background:var(--text);color:var(--black);
      border:none;border-radius:8px;font-family:'Geist Mono',monospace;
      font-size:11px;letter-spacing:.15em;text-transform:uppercase;
      cursor:pointer;transition:opacity .3s,transform .2s;
    }
    .analyze-btn:hover{opacity:.88}
    .analyze-btn:active{transform:scale(.98)}
    .analyze-btn:disabled{opacity:.3;cursor:not-allowed;transform:none}

    /* Progress */
    .progress-wrap{display:none;flex-direction:column;gap:10px}
    .progress-wrap.show{display:flex}
    .progress-bar-bg{height:2px;background:var(--border);border-radius:100px;overflow:hidden}
    .progress-bar{height:100%;background:var(--text);border-radius:100px;width:0%;transition:width .4s ease}
    .progress-status{font-size:11px;color:var(--muted);letter-spacing:.05em;text-align:center}

    /* Profile preview */
    .profile-box{
      display:none;background:var(--surface);border:1px solid var(--border);
      border-radius:10px;padding:16px;
    }
    .profile-box.show{display:block}
    .profile-box-label{font-size:9px;letter-spacing:.2em;color:var(--faint);text-transform:uppercase;margin-bottom:10px}
    .profile-text{font-size:11px;color:var(--muted);line-height:1.8;max-height:160px;overflow-y:auto;letter-spacing:.02em}
    .profile-text::-webkit-scrollbar{width:3px}
    .profile-text::-webkit-scrollbar-thumb{background:var(--border2)}

    .new-session-btn{
      width:100%;padding:12px;background:transparent;color:var(--muted);
      border:1px solid var(--border);border-radius:8px;font-family:'Geist Mono',monospace;
      font-size:10px;letter-spacing:.12em;text-transform:uppercase;
      cursor:pointer;transition:color .3s,border-color .3s;display:none;
    }
    .new-session-btn.show{display:block}
    .new-session-btn:hover{color:var(--text);border-color:var(--border2)}

    .panel-error{font-size:11px;color:#ff8080;text-align:center;display:none;letter-spacing:.03em;line-height:1.6}
    .panel-error.show{display:block}

    /* ── Chat panel ── */
    #chatPanel{
      flex:1;display:flex;flex-direction:column;
      opacity:0;transition:opacity .5s ease;
    }
    #chatPanel.visible{opacity:1}

    /* Empty state */
    .chat-empty{
      flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:16px;padding:40px;text-align:center;
    }
    .chat-empty-glyph{
      font-family:'Cormorant Garamond',serif;font-size:80px;font-weight:300;
      color:var(--faint);line-height:1;
      animation:breathe 7s ease-in-out infinite;
    }
    @keyframes breathe{0%,100%{opacity:.13}50%{opacity:.22}}
    .chat-empty-text{font-size:13px;color:var(--faint);letter-spacing:.08em;line-height:1.8}

    /* Messages */
    .messages{
      flex:1;overflow-y:auto;padding:28px 32px;display:flex;flex-direction:column;gap:20px;
    }
    .messages::-webkit-scrollbar{width:4px}
    .messages::-webkit-scrollbar-thumb{background:var(--border)}

    .msg{display:flex;flex-direction:column;gap:4px;max-width:72%;animation:msgIn .3s ease}
    @keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .msg.user{align-self:flex-end;align-items:flex-end}
    .msg.ai{align-self:flex-start;align-items:flex-start}

    .msg-bubble{
      padding:13px 17px;border-radius:14px;font-size:13px;line-height:1.7;letter-spacing:.02em;
    }
    .msg.user .msg-bubble{
      background:var(--text);color:var(--black);border-radius:14px 14px 4px 14px;
    }
    .msg.ai .msg-bubble{
      background:var(--surface2);border:1px solid var(--border);color:var(--text);
      border-radius:14px 14px 14px 4px;
    }
    .msg-meta{font-size:10px;color:var(--faint);letter-spacing:.05em}

    /* Typing indicator */
    .typing{display:none;align-self:flex-start;padding:14px 18px;background:var(--surface2);border:1px solid var(--border);border-radius:14px 14px 14px 4px}
    .typing.show{display:flex;gap:5px;align-items:center}
    .typing span{width:5px;height:5px;background:var(--faint);border-radius:50%;animation:typeDot 1.2s ease-in-out infinite}
    .typing span:nth-child(2){animation-delay:.2s}
    .typing span:nth-child(3){animation-delay:.4s}
    @keyframes typeDot{0%,80%,100%{transform:scale(.8);opacity:.4}40%{transform:scale(1.1);opacity:1}}

    /* Input bar */
    .input-bar{
      flex-shrink:0;padding:16px 24px;border-top:1px solid var(--border);
      display:flex;align-items:center;gap:12px;
      background:rgba(8,8,8,.8);backdrop-filter:blur(12px);
    }
    .chat-input{
      flex:1;padding:13px 16px;background:var(--surface);border:1px solid var(--border);
      border-radius:10px;color:var(--text);font-family:'Geist Mono',monospace;
      font-size:13px;outline:none;transition:border-color .3s;resize:none;height:46px;
      line-height:1.4;
    }
    .chat-input:focus{border-color:var(--border2)}
    .chat-input::placeholder{color:var(--faint)}
    .send-btn{
      width:46px;height:46px;flex-shrink:0;
      background:var(--text);color:var(--black);border:none;border-radius:10px;
      cursor:pointer;display:flex;align-items:center;justify-content:center;
      transition:opacity .25s,transform .15s;
    }
    .send-btn:hover{opacity:.85}
    .send-btn:active{transform:scale(.94)}
    .send-btn:disabled{opacity:.3;cursor:not-allowed;transform:none}
    .send-btn svg{width:16px;height:16px}

    /* Mobile */
    @media(max-width:700px){
      #uploadPanel{width:100%;border-right:none;border-bottom:1px solid var(--border);max-height:50vh}
      .main{flex-direction:column}
      .messages{padding:20px 16px}
      .msg{max-width:88%}
      .input-bar{padding:12px 16px}
    }
  </style>
</head>
<body>
<div class="app">

  <!-- Top bar -->
  <div class="topbar">
    <div class="topbar-left">
      <div class="logo">CHRONIS</div>
      <div class="demo-tag">Demo</div>
    </div>
    <div class="person-tag" id="personTag">
      <span class="pulse"></span>
      Talking to <strong id="personTagName">—</strong>
    </div>
    <a href="/" class="back-link">← Back</a>
  </div>

  <div class="main">

    <!-- Upload panel -->
    <div id="uploadPanel">
      <div>
        <div class="panel-label">Step 01</div>
        <div class="panel-title">Upload a<br/><em style="font-family:'Cormorant Garamond',serif;font-style:italic;color:rgba(240,237,232,.5)">memory.</em></div>
        <div class="panel-sub" style="margin-top:10px">Upload a video or audio file. Our AI will extract everything — voice, personality, memories — then let you talk to them.</div>
      </div>

      <div class="input-group">
        <div class="input-label">Person's name</div>
        <input type="text" id="personName" placeholder="e.g. Harry"/>
      </div>

      <div>
        <div class="input-label" style="margin-bottom:8px">Upload file</div>
        <div class="dropzone" id="dropzone">
          <input type="file" id="fileInput" accept="video/*,audio/*"/>
          <div class="dz-icon">◈</div>
          <div class="dz-text">Drop your video or audio here<br/>or click to browse</div>
          <div class="dz-sub">MP4 · MOV · MP3 · WAV · M4A · up to 100MB</div>
        </div>
        <div class="file-selected" id="fileSelected">
          <span class="file-icon" id="fileIcon">▷</span>
          <span class="file-name" id="fileName">—</span>
          <button class="file-remove" id="fileRemove">✕</button>
        </div>
      </div>

      <div class="progress-wrap" id="progressWrap">
        <div class="progress-bar-bg"><div class="progress-bar" id="progressBar"></div></div>
        <div class="progress-status" id="progressStatus">Uploading...</div>
      </div>

      <div class="panel-error" id="panelError"></div>

      <button class="analyze-btn" id="analyzeBtn" disabled>Analyze & Begin</button>

      <div class="profile-box" id="profileBox">
        <div class="profile-box-label">Memory profile extracted</div>
        <div class="profile-text" id="profileText"></div>
      </div>

      <button class="new-session-btn" id="newSessionBtn">+ New session</button>
    </div>

    <!-- Chat panel -->
    <div id="chatPanel">
      <!-- Empty state -->
      <div class="chat-empty" id="chatEmpty">
        <div class="chat-empty-glyph">∞</div>
        <div class="chat-empty-text">Upload a video or audio on the left.<br/>Then talk to whoever is in it.</div>
      </div>

      <!-- Messages -->
      <div class="messages" id="messages" style="display:none"></div>
      <div class="typing" id="typing">
        <span></span><span></span><span></span>
      </div>

      <!-- Input -->
      <div class="input-bar" id="inputBar" style="display:none">
        <textarea class="chat-input" id="chatInput" placeholder="Say something..." rows="1"></textarea>
        <button class="send-btn" id="sendBtn" disabled>
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 8H2M9 3l5 5-5 5"/>
          </svg>
        </button>
      </div>
    </div>

  </div>
</div>

<script>
  let sessionId   = null;
  let personName  = '';
  let selectedFile = null;

  const fileInput    = document.getElementById('fileInput');
  const dropzone     = document.getElementById('dropzone');
  const fileSelected = document.getElementById('fileSelected');
  const fileName     = document.getElementById('fileName');
  const fileIcon     = document.getElementById('fileIcon');
  const fileRemove   = document.getElementById('fileRemove');
  const analyzeBtn   = document.getElementById('analyzeBtn');
  const personNameIn = document.getElementById('personName');
  const progressWrap = document.getElementById('progressWrap');
  const progressBar  = document.getElementById('progressBar');
  const progressStatus = document.getElementById('progressStatus');
  const panelError   = document.getElementById('panelError');
  const profileBox   = document.getElementById('profileBox');
  const profileText  = document.getElementById('profileText');
  const newSessionBtn = document.getElementById('newSessionBtn');

  const chatEmpty = document.getElementById('chatEmpty');
  const messages  = document.getElementById('messages');
  const typing    = document.getElementById('typing');
  const inputBar  = document.getElementById('inputBar');
  const chatInput = document.getElementById('chatInput');
  const sendBtn   = document.getElementById('sendBtn');
  const chatPanel = document.getElementById('chatPanel');
  const personTag = document.getElementById('personTag');
  const personTagName = document.getElementById('personTagName');

  // Make chat panel visible immediately
  chatPanel.classList.add('visible');

  // ── File selection ──
  function setFile(file) {
    if (!file) return;
    selectedFile = file;
    const isVideo = file.type.startsWith('video');
    fileIcon.textContent = isVideo ? '▷' : '♪';
    fileName.textContent = file.name;
    dropzone.style.display = 'none';
    fileSelected.classList.add('show');
    checkReady();
  }

  fileInput.addEventListener('change', () => { if (fileInput.files[0]) setFile(fileInput.files[0]); });

  dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('drag-over'); });
  dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-over'));
  dropzone.addEventListener('drop', (e) => {
    e.preventDefault(); dropzone.classList.remove('drag-over');
    const f = e.dataTransfer.files[0];
    if (f) { fileInput.files = e.dataTransfer.files; setFile(f); }
  });

  fileRemove.addEventListener('click', () => {
    selectedFile = null; fileInput.value = '';
    fileSelected.classList.remove('show');
    dropzone.style.display = '';
    checkReady();
  });

  personNameIn.addEventListener('input', checkReady);

  function checkReady() {
    analyzeBtn.disabled = !(selectedFile && personNameIn.value.trim());
  }

  function showError(msg) {
    panelError.textContent = msg;
    panelError.classList.add('show');
  }
  function hideError() { panelError.classList.remove('show'); }

  // ── Animate progress bar ──
  function animateProgress(targetPct, status, duration=800) {
    progressStatus.textContent = status;
    const start = parseFloat(progressBar.style.width) || 0;
    const diff  = targetPct - start;
    const startTime = performance.now();
    function step(now) {
      const t = Math.min((now - startTime) / duration, 1);
      const ease = t < .5 ? 2*t*t : -1+(4-2*t)*t;
      progressBar.style.width = (start + diff * ease) + '%';
      if (t < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  // ── Analyze ──
  analyzeBtn.addEventListener('click', async () => {
    if (!selectedFile || !personNameIn.value.trim()) return;
    personName = personNameIn.value.trim();
    hideError();

    analyzeBtn.disabled = true;
    progressWrap.classList.add('show');
    animateProgress(15, 'Uploading file...', 600);

    const fd = new FormData();
    fd.append('file', selectedFile);
    fd.append('person_name', personName);

    try {
      animateProgress(35, 'Sending to AI...');
      const res  = await fetch('/api/analyze', { method: 'POST', body: fd });

      animateProgress(70, 'Extracting memories...');
      const data = await res.json();

      if (!res.ok) {
        showError(data.error || 'Analysis failed. Please try again.');
        progressWrap.classList.remove('show');
        analyzeBtn.disabled = false;
        return;
      }

      animateProgress(100, 'Profile complete ✓');

      setTimeout(() => {
        sessionId = data.session_id;

        // Show profile
        profileText.textContent = data.profile.slice(0, 600) + (data.profile.length > 600 ? '...' : '');
        profileBox.classList.add('show');
        newSessionBtn.classList.add('show');
        progressWrap.classList.remove('show');

        // Update topbar
        personTagName.textContent = personName;
        personTag.classList.add('show');

        // Switch to chat
        chatEmpty.style.display = 'none';
        messages.style.display  = 'flex';
        inputBar.style.display  = 'flex';
        sendBtn.disabled = false;

        // Greeting message from the AI
        appendMessage('ai', `Hey, it's ${personName}. What's up?`);

        // Focus input
        setTimeout(() => chatInput.focus(), 100);
      }, 600);

    } catch (err) {
      showError('Network error. Check your connection and try again.');
      progressWrap.classList.remove('show');
      analyzeBtn.disabled = false;
    }
  });

  // ── New session ──
  newSessionBtn.addEventListener('click', () => {
    sessionId   = null;
    personName  = '';
    selectedFile = null;
    fileInput.value = '';
    personNameIn.value = '';
    fileSelected.classList.remove('show');
    dropzone.style.display = '';
    profileBox.classList.remove('show');
    newSessionBtn.classList.remove('show');
    progressWrap.classList.remove('show');
    progressBar.style.width = '0%';
    analyzeBtn.disabled = true;
    hideError();
    personTag.classList.remove('show');
    messages.innerHTML = '';
    messages.style.display = 'none';
    inputBar.style.display = 'none';
    chatEmpty.style.display = '';
    sendBtn.disabled = true;
  });

  // ── Chat ──
  function appendMessage(role, text) {
    const wrap = document.createElement('div');
    wrap.className = `msg ${role}`;
    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    bubble.textContent = text;
    const meta = document.createElement('div');
    meta.className = 'msg-meta';
    meta.textContent = role === 'user' ? 'You' : personName;
    wrap.appendChild(bubble);
    wrap.appendChild(meta);
    messages.appendChild(wrap);
    messages.scrollTop = messages.scrollHeight;
  }

  async function sendMessage() {
    const text = chatInput.value.trim();
    if (!text || !sessionId) return;

    chatInput.value = '';
    chatInput.style.height = '46px';
    sendBtn.disabled = true;
    appendMessage('user', text);

    // Show typing
    messages.appendChild(typing);
    typing.classList.add('show');
    messages.scrollTop = messages.scrollHeight;

    try {
      const res  = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: sessionId, message: text }),
      });
      const data = await res.json();
      typing.classList.remove('show');

      if (res.ok) {
        appendMessage('ai', data.reply);
      } else {
        appendMessage('ai', `[Error: ${data.error || 'something went wrong'}]`);
      }
    } catch {
      typing.classList.remove('show');
      appendMessage('ai', '[Connection error — please try again]');
    }

    sendBtn.disabled = false;
    chatInput.focus();
  }

  sendBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });

  // Auto-resize textarea
  chatInput.addEventListener('input', () => {
    chatInput.style.height = '46px';
    chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
  });
</script>
</body>
</html>